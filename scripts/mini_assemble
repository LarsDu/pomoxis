#!/bin/bash

usage="$(basename "$0") [-h] -i <fastq>

Assemble fastq/fasta formatted reads and perform POA consensus.

    -h  show this help text.
    -i  fastx input reads (required).
    -q  use qualities as is (default: false).
    -r  reference fasta for reference-guided consensus (instead of de novo assembly)
    -o  output folder (default: assm).
    -p  output file prefix (default: reads).
    -t  number of minimap and racon threads (default: 1)."

OUTPUT="assm"
NAME="reads"
THREADS=1
USEQUAL=false
iflag=false
rflag=false
while getopts ':hi:q:r:o:p:t:' option; do
  case "$option" in
    h  ) echo "$usage" >&2; exit;;
    i  ) iflag=true; INPUT=$OPTARG;;
    q  ) USEQUAL=true;;
    r  ) rflag=true; REF=$OPTARG;;
    o  ) OUTPUT=$OPTARG;;
    p  ) NAME=$OPTARG;;
    t  ) THREADS=$OPTARG;;
    \? ) echo "Invalid option: -${OPTARG}." >&2; exit 1;;
    :  ) echo "Option -$OPTARG requires an argument." >&2; exit 1;;
  esac
done
shift $(($OPTIND - 1))

if ! $iflag; then
  echo "$usage" >&2;
  echo "-i must be specified." >&2;
  exit 1;
fi

if [[ ! -e ${OUTPUT} ]]; then
  mkdir -p ${OUTPUT}
else
  echo "Output ${OUTPUT} already exists." >&2; exit 1
fi

# Simple test for fastq
ext=$(sed 's/^\w\+.//' <<< "${INPUT}")
FASTQ=${OUTPUT}/${NAME}.fq
MOCKQ=10
if [ "$ext" = 'fq' ] || [ "$ext" = 'fastq' ]; then
  if ${USEQUAL}; then
    cp ${INPUT} ${FASTQ}
  else
    cat ${INPUT} | fast_convert qq --discard_q --mock_q ${MOCKQ} > ${FASTQ}
  fi
else
  cat ${INPUT} | fast_convert aq --mock_q ${MOCKQ} > ${FASTQ}
fi

cd ${OUTPUT}

if ! $rflag; then 

  ASMOPTS="-s 100 -e 3"

  echo "Overlapping reads..."
  minimap -Sw5 -L100 -m0 -t${THREADS} ${NAME}.fq ${NAME}.fq | gzip -1 > ${NAME}.paf.gz
  echo "Assembling graph..."
  miniasm ${ASMOPTS} -f ${NAME}.fq ${NAME}.paf.gz | tee ${NAME}.gfa | awk '/^S/{print ">"$2"\n"$3}' > ${NAME}.gfa.fasta

  DRAFT=${NAME}.gfa.fasta

else
  echo "Using supplied reference to perform reference-guided consensus..."
  DRAFT=${REF}
fi

READS=${NAME}.fq

for ROUND in {01..04}; do
     echo "Running round ${ROUND} consensus"
     READS2TIGS=reads2contigs_${ROUND}.paf
     NEWDRAFT=racon_${ROUND}.fasta
     minimap ${DRAFT} ${READS} > ${READS2TIGS}
     racon -M 8 -X -1 -G -4 -E -1 -t ${THREADS} --bq -1  ${READS} ${READS2TIGS} ${DRAFT} ${NEWDRAFT}
     DRAFT=${NEWDRAFT}
done;

FINAL=${NAME}_final.fa
cp ${DRAFT} ${FINAL}
echo "Final assembly written to ${OUTPUT}/${FINAL}. Have a nice day."
